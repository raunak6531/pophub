{% extends 'base.html' %}
{% block content %}
<h3 class="mb-3">My Lists</h3>

<ul class="nav nav-tabs" role="tablist">
  <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#watch">Watchlist (Movies/TV)</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#play">Backlog (Games)</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#listen">Playlist (Albums)</button></li>
</ul>

<div class="tab-content pt-3">
  <div class="tab-pane fade show active" id="watch">
    <div class="row g-3">
      {% for it in grouped.watch %}
      <div class="col-6 col-md-3">
        <div class="card h-100">
          {% if it.cover %}<img src="{{ it.cover }}" class="card-img-top" alt="cover">{% endif %}
          <div class="card-body">
            <span class="badge bg-secondary text-uppercase">{{ it.type }}</span>
            <h6 class="mt-2">{{ it.title }} {% if it.year %}<small class="text-muted">({{ it.year }})</small>{% endif %}</h6>
            <button class="btn btn-sm btn-outline-danger list-toggle" data-type="{{ it.type }}" data-id="{{ it.id }}" data-list="watch">Remove</button>
          </div>
        </div>
      </div>
      {% empty %}
      <div class="text-muted">No items yet.</div>
      {% endfor %}
    </div>
  </div>

  <div class="tab-pane fade" id="play">
    <div class="row g-3">
      {% for it in grouped.play %}
      <div class="col-6 col-md-3">
        <div class="card h-100">
          {% if it.cover %}<img src="{{ it.cover }}" class="card-img-top" alt="cover">{% endif %}
          <div class="card-body">
            <span class="badge bg-secondary text-uppercase">{{ it.type }}</span>
            <h6 class="mt-2">{{ it.title }} {% if it.year %}<small class="text-muted">({{ it.year }})</small>{% endif %}</h6>
            <button class="btn btn-sm btn-outline-danger list-toggle" data-type="{{ it.type }}" data-id="{{ it.id }}" data-list="play">Remove</button>
          </div>
        </div>
      </div>
      {% empty %}
      <div class="text-muted">No items yet.</div>
      {% endfor %}
    </div>
  </div>

  <div class="tab-pane fade" id="listen">
    <div class="row g-3">
      {% for it in grouped.listen %}
      <div class="col-6 col-md-3">
        <div class="card h-100">
          {% if it.cover %}<img src="{{ it.cover }}" class="card-img-top" alt="cover">{% endif %}
          <div class="card-body">
            <span class="badge bg-secondary text-uppercase">{{ it.type }}</span>
            <h6 class="mt-2">{{ it.title }} {% if it.year %}<small class="text-muted">({{ it.year }})</small>{% endif %}</h6>
            <button class="btn btn-sm btn-outline-danger list-toggle" data-type="{{ it.type }}" data-id="{{ it.id }}" data-list="listen">Remove</button>
          </div>
        </div>
      </div>
      {% empty %}
      <div class="text-muted">No items yet.</div>
      {% endfor %}
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// reuse the same AJAX endpoint to remove items
$(document).on('click', '.list-toggle', function() {
  const btn = $(this);
  $.post('/api/list/toggle', {
    item_id: btn.data('id'),
    item_type: btn.data('type'),
    list_type: btn.data('list'),
    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
  }, function(resp) {
    // remove the card from the grid on success
    btn.closest('.col-6, .col-md-3').remove();
  }).fail(function() {
    alert("Failed to update list (are you logged in?)");
  });
});
</script>
{% endblock %}
